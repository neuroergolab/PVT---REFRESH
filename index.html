<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PVT Task</title>
  <style>
    html, body { height: 100%; margin: 0; }
    body {
      background: #0f172a; color: #e2e8f0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      display: flex; justify-content: center; align-items: center; flex-direction: column;
      -webkit-tap-highlight-color: transparent;
      user-select: none; touch-action: manipulation;
      text-align: center;
    }
    .dot {
      position: fixed;
      left: 50%; top: 50%; transform: translate(-50%, -50%);
      width: 50px; height: 50px; border-radius: 50%; background: #ef4444;
      box-shadow: 0 0 0 6px rgba(239,68,68,.2), 0 0 50px rgba(239,68,68,.35);
      display: none;
      z-index: 9999;
    }
    button { margin: 10px; padding: 10px 20px; font-size: 16px; }
    #instructions { max-width: 560px; margin-bottom: 16px; color: #cbd5e1; }
    #gate { display: flex; flex-direction: column; align-items: center; gap: 8px; }
    #pidWrap { display: flex; gap: 8px; align-items: center; }
    label { color: #cbd5e1; }
    input[type="text"]{ padding: 8px 10px; border-radius: 10px; border: 1px solid #334155; background: #0b1220; color: #e2e8f0; }
    #thanks { display: none; margin-top: 20px; font-size: 18px; color: #e2e8f0; }
  </style>
</head>
<body>
  <div id="instructions">
    <h2>Instructions</h2>
    <p>A red dot will appear in the center at random intervals.</p>
    <p>Tap or click it as quickly as possible each time it appears.</p>
    <p>Continue the task until it ends. The task will last for <span id="taskLen">5 minutes</span>.</p>
    <p>Enter your Participant ID, then press Start.</p>
  </div>
  <div id="gate">
    <div id="pidWrap">
      <label for="participantId">Participant ID:</label>
      <input id="participantId" type="text" placeholder="e.g., P001" autocomplete="off" />
    </div>
    <button id="startBtn">Start PVT</button>
  </div>

  <div id="dot" class="dot" aria-hidden="true"></div>
  <div id="thanks">Thank you for completing the task.</div>

  <!-- EmailJS SDK (client-side email) -->
  <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>

<script>
(function(){
  const dot = document.getElementById('dot');
  const startBtn = document.getElementById('startBtn');
  const instructions = document.getElementById('instructions');
  const pidInput = document.getElementById('participantId');
  const gate = document.getElementById('gate');
  const thanks = document.getElementById('thanks');

  // === PVT settings (debug) ===
  const TASK_DURATION_MS = 5 * 60 * 1000; // 5 minutes
  const MIN_DELAY_MS = 2000;
  const MAX_DELAY_MS = 10000;
  const LAPSE_THRESHOLD_MS = 500; // lapse if RT > 500 ms
  const FALSE_START_THRESHOLD_MS = 100; // false start if RT < 100 ms
  const TIMEOUT_MS = 10000; // auto-timeout after 10 s
  const FIRST_DELAY_MS = 2000; // first stimulus fixed at 2 s

  // Human-readable task length
  const taskLenEl = document.getElementById('taskLen');
  if (taskLenEl) taskLenEl.textContent = '5 minutes';

  // === EmailJS config ===
  // We will send a JSON attachment via Variable Attachment to avoid CSV issues.
  // In EmailJS template settings:
  //  - Add variables: to_email, subject, file_filename, file_content
  //  - Add an Attachment of type "Variable Attachment"
  //      Param name: file_content
  //      Content type: application/json
  //      Filename: {{file_filename}}
  //  - In the template, set To = {{to_email}}, Subject = {{subject}}
  const EMAILJS_PUBLIC_KEY = 'YOUR_PUBLIC_KEY';
  const EMAILJS_SERVICE_ID = 'YOUR_SERVICE_ID';
  const EMAILJS_TEMPLATE_ID = 'YOUR_TEMPLATE_ID';
  const EMAIL_ENABLED = EMAILJS_PUBLIC_KEY && !EMAILJS_PUBLIC_KEY.includes('YOUR_') && EMAILJS_SERVICE_ID && !EMAILJS_SERVICE_ID.includes('YOUR_') && EMAILJS_TEMPLATE_ID && !EMAILJS_TEMPLATE_ID.includes('YOUR_');
  try { emailjs.init({ publicKey: EMAILJS_PUBLIC_KEY }); } catch(e) { console.error('EmailJS init failed', e); }

  // === Google Apps Script Webhook (preferred) ===
  // Paste your Web App URL below. Example: https://script.google.com/macros/s/AKfycbx.../exec
  const WEBHOOK_URL = 'https://script.google.com/macros/s/AKfycbwUEkpoENX5wXiMZtngDdB23BJKA14Ng04goBmDLuzx03SwXL7pJZr_x2u7dNQpL-w3/exec';
  const WEBHOOK_ENABLED = WEBHOOK_URL && WEBHOOK_URL.startsWith('http');

  let running = false;
  let completed = false; // lock after one run
  let appearAt = 0;
  let nextDotTimeout = null;
  let endTime = 0;
  let participantId = '';
  let trial = 0;
  let falseStarts = 0;
  let lapses = 0;
  let firstStimulus = true;
  let results = [];
  let dotTimeoutId = null;
  let sessionStartLocal = '';

  function placeDot(){
    dot.style.display = 'block';
    appearAt = performance.now();
    // start per-trial timeout
    clearTimeout(dotTimeoutId);
    dotTimeoutId = setTimeout(onStimulusTimeout, TIMEOUT_MS);
  }

  function hideDot(){
    dot.style.display = 'none';
    appearAt = 0;
    clearTimeout(dotTimeoutId);
    dotTimeoutId = null;
  }

  function scheduleNextDot(){
    const delay = firstStimulus ? FIRST_DELAY_MS : (Math.random() * (MAX_DELAY_MS - MIN_DELAY_MS) + MIN_DELAY_MS);
    firstStimulus = false;
    nextDotTimeout = setTimeout(() => {
      if (!running) return;
      placeDot();
    }, delay);
  }

  function start(){
    if (running || completed) return; // do not allow reruns
    const id = (pidInput.value || '').trim();
    if (!id) { alert('Please enter a Participant ID to begin.'); pidInput.focus(); return; }
    participantId = id;

    sessionStartLocal = new Date().toLocaleString();

    running = true;
    results = [];
    trial = 0; falseStarts = 0; lapses = 0; firstStimulus = true;

    // hide UI
    gate.style.display = 'none';
    instructions.style.display = 'none';

    const startAt = performance.now();
    endTime = startAt + TASK_DURATION_MS;
    scheduleNextDot();

    const timerId = setInterval(() => {
      if (performance.now() >= endTime) {
        clearInterval(timerId);
        finish();
      }
    }, 250);
  }

  async function sendToWebhook(){
    const payload = {
      participant_id: participantId,
      start_time_local: sessionStartLocal,
      local_time: new Date().toLocaleString(),
      summary: { trials: trial, false_starts: falseStarts, lapses },
      rows: results
    };
    // Use text/plain + no-cors to avoid CORS preflight with Apps Script Web App
    await fetch(WEBHOOK_URL, {
      method: 'POST',
      mode: 'no-cors',
      headers: { 'Content-Type': 'text/plain;charset=utf-8' },
      body: JSON.stringify(payload)
    });
  }

  async function finish(){
    running = false;
    completed = true; // lock task
    clearTimeout(nextDotTimeout);
    hideDot();

    // show thank you and keep controls hidden
    thanks.style.display = 'block';

    if (results.length > 0) {
      try {
        if (WEBHOOK_ENABLED) {
          await sendToWebhook();
        } else if (EMAIL_ENABLED) {
          await sendEmailWithAttachment();
        } else {
          alert('No upload configured. Results will be saved locally as JSON.');
          saveJSONLocally();
        }
      } catch (err) {
        console.error('Upload failed, saving locally instead', err);
        alert('Upload failed. Results will be saved locally as JSON.');
        saveJSONLocally();
      }
    }
  }

  function recordResponse(){
    if (!running) return;
    if (!appearAt) return; // ignore if stimulus not visible
    const rt = Math.round(performance.now() - appearAt);
    const ts = new Date().toISOString();

    if (rt < FALSE_START_THRESHOLD_MS) {
      // too fast after onset -> false start
      falseStarts++;
      trial++;
      results.push({ event: 'false_start', trial, rt, lapse: 0, false_start: 1, ts });
    } else {
      const lapseFlag = rt > LAPSE_THRESHOLD_MS ? 1 : 0;
      if (lapseFlag) lapses++;
      trial++;
      results.push({ event: 'response', trial, rt, lapse: lapseFlag, false_start: 0, ts });
    }

    hideDot();
    if (performance.now() < endTime) scheduleNextDot();
  });
    hideDot();
    if (performance.now() < endTime) scheduleNextDot();
  }

  function onBackgroundTap(e){
    if (!running) return;
    // If dot is not visible, any tap/click is a false start (anticipatory)
    if (!appearAt){
      e.preventDefault();
      falseStarts++;
      const ts = new Date().toISOString();
      results.push({ event: 'false_start', trial: '', rt: '', lapse: '', false_start: 1, ts });
    }
  }

  function onStimulusTimeout(){
    // No response within TIMEOUT_MS after stimulus onset
    if (!running || !appearAt) return;
    const ts = new Date().toISOString();
    trial++;
    lapses++;
    const rt = TIMEOUT_MS; // treat as 10s RT per spec
    results.push({ event: 'timeout', trial, rt, lapse: 1, false_start: 0, ts });
    hideDot();
    if (performance.now() < endTime) scheduleNextDot();
  });
    }
  }

  function buildJSON(){
    return JSON.stringify({
      participant_id: participantId,
      start_time_local: sessionStartLocal,
      summary: { trials: trial, false_starts: falseStarts, lapses },
      rows: results
    }, null, 2);
  }

  function saveJSONLocally(){
    const json = buildJSON();
    const blob = new Blob([json], {type: 'application/json;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    const safeId = participantId.replace(/[^a-zA-Z0-9_-]/g,'_') || 'PID';
    const localStamp = new Date().toLocaleString().replace(/[\\/:]/g,'-').replace(/\s+/g,'_');
    a.href = url; a.download = `pvt_${safeId}_${localStamp}.json`;
    document.body.appendChild(a); a.click(); a.remove();
    URL.revokeObjectURL(url);
  }

  function blobToBase64(blob){
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = () => {
        const dataUrl = reader.result; // data:...;base64,....
        const base64 = String(dataUrl).split(',')[1] || '';
        resolve(base64);
      };
      reader.onerror = reject;
      reader.readAsDataURL(blob);
    });
  }

  async function sendEmailWithAttachment(){
    const json = buildJSON();
    const blob = new Blob([json], {type: 'application/json;charset=utf-8;'});
    const base64 = await blobToBase64(blob);

    const safeId = participantId.replace(/[^a-zA-Z0-9_-]/g,'_') || 'PID';
    const localStamp = new Date().toLocaleString(); // human local time for subject
    const subject = `PVT_${safeId}_${localStamp}`;
    const filename = `pvt_${safeId}_${localStamp.replace(/[\\/:]/g,'-').replace(/\s+/g,'_')}.json`;

    const params = {
      to_email: 'shanghavi@wisc.edu',
      subject,
      file_filename: filename,
      file_content: base64
    };

    // Template must have Variable Attachment with param file_content and content type application/json
    return emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, params);
  }

  startBtn.addEventListener('click', start);
  dot.addEventListener('pointerdown', recordResponse);
  document.addEventListener('pointerdown', onBackgroundTap, { passive: false, capture: true });
})();
</script>
</body>
</html>
