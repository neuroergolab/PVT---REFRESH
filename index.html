<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PVT Debug</title>
  <style>
    html, body { height: 100%; margin: 0; }
    body {
      background: #0f172a; color: #e2e8f0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      display: flex; justify-content: center; align-items: center; flex-direction: column;
      -webkit-tap-highlight-color: transparent;
      user-select: none; touch-action: manipulation;
      text-align: center;
    }
    .dot {
      position: fixed;
      left: 50%; top: 50%; transform: translate(-50%, -50%);
      width: 50px; height: 50px; border-radius: 50%; background: #ef4444;
      box-shadow: 0 0 0 6px rgba(239,68,68,.2), 0 0 50px rgba(239,68,68,.35);
      display: none;
      z-index: 9999;
    }
    button { margin: 10px; padding: 10px 20px; font-size: 16px; }
    #instructions { max-width: 500px; margin-bottom: 20px; color: #cbd5e1; }
  </style>
</head>
<body>
  <div id="instructions">
    <h2>Instructions</h2>
    <p>When you press Start, a red dot will appear in the center of the screen at random intervals. Your task is to tap or click the dot as quickly as possible each time it appears. The task will run for a short time and your reaction times will be saved automatically.</p>
  </div>
  <button id="startBtn">Start PVT (Debug)</button>
  <div id="dot" class="dot"></div>

<script>
(function(){
  const dot = document.getElementById('dot');
  const startBtn = document.getElementById('startBtn');
  const instructions = document.getElementById('instructions');

  const TASK_DURATION_MS = 10000; // 10 seconds for debugging
  const MIN_DELAY_MS = 500;
  const MAX_DELAY_MS = 1500;

  let running = false;
  let appearAt = 0;
  let nextDotTimeout = null;
  let endTime = 0;
  let results = [];

  function placeDot(){
    dot.style.display = 'block';
    appearAt = performance.now();
  }

  function hideDot(){
    dot.style.display = 'none';
    appearAt = 0;
  }

  function scheduleNextDot(){
    const delay = Math.random() * (MAX_DELAY_MS - MIN_DELAY_MS) + MIN_DELAY_MS;
    nextDotTimeout = setTimeout(() => {
      if (!running) return;
      placeDot();
    }, delay);
  }

  function start(){
    if (running) return;
    running = true;
    results = [];
    startBtn.style.display = 'none';
    instructions.style.display = 'none';

    const startAt = performance.now();
    endTime = startAt + TASK_DURATION_MS;
    scheduleNextDot();

    const timerId = setInterval(() => {
      if (performance.now() >= endTime) {
        clearInterval(timerId);
        finish();
      }
    }, 250);
  }

  function finish(){
    running = false;
    clearTimeout(nextDotTimeout);
    hideDot();
    startBtn.style.display = 'block';
    instructions.style.display = 'block';
    if (results.length > 0) {
      saveCSV();
    }
  }

  function recordResponse(){
    if (!running) return;
    if (!appearAt) return;
    const rt = Math.round(performance.now() - appearAt);
    results.push({ rt });
    hideDot();
    if (performance.now() < endTime) scheduleNextDot();
  }

  function saveCSV(){
    const header = ['trial','rt_ms'];
    const rows = results.map((r,i) => [i+1, r.rt]);
    const csv = [header.join(','), ...rows.map(r => r.join(','))].join('\n');
    const blob = new Blob([csv], {type: 'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = `pvt_${new Date().toISOString().replaceAll(':','-')}.csv`;
    document.body.appendChild(a); a.click(); a.remove();
    URL.revokeObjectURL(url);
  }

  startBtn.addEventListener('click', start);
  dot.addEventListener('click', recordResponse);
  dot.addEventListener('touchstart', (e)=>{ e.preventDefault(); recordResponse(); }, {passive:false});
})();
</script>
</body>
</html>
