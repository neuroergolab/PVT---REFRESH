<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>5‑Minute PVT</title>
  <style>
    body {
      margin: 0; height: 100%; background: #0f172a; color: #e2e8f0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      display: flex; justify-content: center; align-items: center; flex-direction: column;
    }
    .dot {
      width: 50px; height: 50px; border-radius: 50%; background: #ef4444;
      display: none;
    }
    button { margin: 10px; padding: 10px 20px; font-size: 16px; }
  </style>
</head>
<body>
  <button id="startBtn">Start 5‑min PVT</button>
  <div id="dot" class="dot"></div>
  <button id="downloadBtn" disabled>Download CSV</button>

<script>
(function(){
  const dot = document.getElementById('dot');
  const startBtn = document.getElementById('startBtn');
  const downloadBtn = document.getElementById('downloadBtn');

  const TASK_DURATION_MS = 5 * 60 * 1000; // 5 minutes
  const MIN_DELAY_MS = 2000;
  const MAX_DELAY_MS = 10000;

  let running = false;
  let appearAt = 0;
  let nextDotTimeout = null;
  let endTime = 0;
  let results = [];

  function placeDot(){
    dot.style.display = 'block';
    appearAt = performance.now();
  }

  function hideDot(){
    dot.style.display = 'none';
    appearAt = 0;
  }

  function scheduleNextDot(){
    const delay = Math.random() * (MAX_DELAY_MS - MIN_DELAY_MS) + MIN_DELAY_MS;
    nextDotTimeout = setTimeout(() => {
      if (!running) return;
      placeDot();
    }, delay);
  }

  function start(){
    if (running) return;
    running = true;
    results = [];
    startBtn.disabled = true;
    downloadBtn.disabled = true;

    const startAt = performance.now();
    endTime = startAt + TASK_DURATION_MS;
    scheduleNextDot();

    const timerId = setInterval(() => {
      if (performance.now() >= endTime) {
        clearInterval(timerId);
        finish();
      }
    }, 250);
  }

  function finish(){
    running = false;
    clearTimeout(nextDotTimeout);
    hideDot();
    startBtn.disabled = false;
    downloadBtn.disabled = results.length === 0;
  }

  function recordResponse(){
    if (!running) return;
    if (!appearAt) return; // ignore clicks when dot not visible
    const rt = Math.round(performance.now() - appearAt);
    results.push({ rt });
    hideDot();
    if (performance.now() < endTime) scheduleNextDot();
  }

  function toCSV(){
    const header = ['trial','rt_ms'];
    const rows = results.map((r,i) => [i+1, r.rt]);
    const csv = [header.join(','), ...rows.map(r => r.join(','))].join('\n');
    const blob = new Blob([csv], {type: 'text/csv;charset=utf-8;'});
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url; a.download = `pvt_${new Date().toISOString().replaceAll(':','-')}.csv`;
    document.body.appendChild(a); a.click(); a.remove();
    URL.revokeObjectURL(url);
  }

  startBtn.addEventListener('click', start);
  dot.addEventListener('click', recordResponse);
  dot.addEventListener('touchstart', recordResponse);
  downloadBtn.addEventListener('click', toCSV);
})();
</script>
</body>
</html>
